#*
 * query_api.vtl
 * Test format to demonstrate usage of Cascade locator tool and Query API.
 *
 * For more info, see spike user story:
 * https://trello.com/c/InwKZ4w9
 *#

#import( "/_cascade/formats/helpers/debug.velocity" )

##
## Hardcoded Params
##


##
## Vars
##
#set ( $currentPage = $_XPathTool.selectSingleNode($contentRoot, "//system-page[@current = 'true']") )


##
## Macros
##
#macro ( debugPathTools )
  #set ( $currentPath = $currentPage.getChild('path').value )
  #set ( $pathList = $currentPath.split('/') )
  #set ( $parentIndex = $pathList.size() - 2 )
  #set ( $parentFolderName = $pathList.get($parentIndex) )
  #set ( $grandParentPath = $_StringTool.substringBefore($currentPath, $parentFolderName) )

  <pre>
  # debugPathTools
  currentPage.parentFolder: $currentPage.parentFolder
  isNull: $_PropertyTool.isNull($currentPage.parentFolder)
  currentPath: $currentPath
  pathList.size: $pathList.size()
  parentFolderName: $parentFolderName
  grandParentPath: $grandParentPath
  </pre>
#end

#macro ( queryCurrentPageParentSiblings )
  ## Note: Velocity (Java) arrays don't have a pop or remove method.
  #set ( $parentSiblings = [] )

  #set ( $currentPath = $currentPage.getChild('path').value )
  #set ( $pathList = $currentPath.split('/') )
  #set ( $parentIndex = $pathList.size() - 2 )
  #set ( $parentFolderName = $pathList.get($parentIndex) )

  ## locateFolder fails with trailing slashes. Thus the leading slash added here.
  ## This will also need some sanity checks for paths less than 3 folders deep.
  #set ( $grandParentPath = $_StringTool.substringBefore($currentPath, "/${parentFolderName}") )
  #set ( $grandParentFolder = $_.locateFolder($grandParentPath) )

  #foreach( $parentSibling in $grandParentFolder.children )
    ## add method returns boolean which will displayed if not assigned to var.
    #set ( $discard = $parentSiblings.add($parentSibling) )
  #end

  <pre>
  # queryCurrentPageParentSiblings
  currentPath: $currentPath
  grandParentPath: $grandParentPath
  grandParentFolder isNull?: $_PropertyTool.isNull($grandParentFolder)
  parentSiblings: ${_DisplayTool.list($parentSiblings,"/")}
  grandParentFolder.path: $grandParentFolder.path

  # ParentSiblings: title : visible?
  #foreach( $parentSibling in $grandParentFolder.children )
    #set ( $hideSettingSelector = "dynamic-metadata[1][value='Yes'] or system-page[name = 'index']/dynamic-metadata[1][value='Yes']" )
    #set ( $isVisible = $_XPathTool.selectNodes($parentSibling, $hideSettingSelector) == [false] )
    $parentSibling.name : $isVisible
  #end
  </pre>
#end



##
## Main Format Block
##
<div id="format-results">

  <pre>
  # currentPage
  currentPage current?: $currentPage.getAttributeValue('current')
  currentPage title: $currentPage.getChild("title").value
  currentPage path: $currentPage.getChild('path').value

  ##$_PropertyTool.outputProperties( $currentPage )
  </pre>

  #queryCurrentPageParentSiblings()
  #debugPathTools()

</div>
